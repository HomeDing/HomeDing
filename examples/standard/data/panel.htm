<!doctype html><html><head><meta charset='utf-8'><meta name='viewport'content='width=device-width,initial-scale=1'><title>Element Panel</title><link href='/iotstyle.css'rel='stylesheet'type='text/css'><script src='micro.js'></script><script src='microsvg.js'></script><script src='panel.js'></script><style>#panel{fill:none;background-color:silver;background-image:linear-gradient(to top,rgba(0,0,0,.2) 1px,transparent 1px),linear-gradient(to left,rgba(0,0,0,.2) 1px,transparent 1px);background-size:72px 72px}#panel #templates{display:none}#links>line,#links>path{stroke:#080808;stroke-width:3;stroke-linecap:round;marker-end:url(#arrow)}.node{font-size:12px;font-family:sans-serif;fill:#000000;fill-opacity:1;stroke:none;font-style:normal;font-weight:400}.node rect{fill:#d4dced;stroke-width:0}.node circle{fill:#505050;stroke-width:0}.node text{font-size:10px}#Grid{fill:#e0e0e0;stroke:none}</style></head><body><div class='container'><div class='row u-header'><h1>Panel</h1></div><div class='row u-navbar'><a class='button'href='/'>Home</a> <a class='button'href='/board.htm'>Board</a> <a class='button'href='/microide.htm'>IDE</a> <a class='button'href='/log.htm'>Log</a> <span class='gap'></span> <button id='sysButton'>sys</button></div><div class='row'style='margin-top:.5em;user-select:none'><svg id='panel'><defs><marker id='arrow'markerWidth='6'markerHeight='6'refX='16'refY='8'orient='auto'xmarkerUnits='strokeWidth'viewBox='0 0 16 16'><path d='M0,0 L0,16 L16,8 z'fill='currentColor'/></marker></defs><rect height='100%'width='100%'></rect><g id='templates'><g dragabble='true'class='node'><title></title><rect width='64'height='64'rx='8'></rect><use class='icon'x='16'y='8'width='32'height='32'color='#203050'href=''/><use class='config'x='48'y='4'width='12'height='12'color='#203050'href='/icons.svg#config'/><text class='id'x='32'y='56'text-anchor='middle'>subtitle</text><circle pin='in'cx='8'cy='40'r='5'></circle><circle pin='out'dragabble='true'cx='56'cy='40'r='5'></circle></g></g><g id='viewport'><g id='nodes'></g><g id='links'></g></g><g id='connect'style='fill:lime'><rect x='474'y='112'width='64'height='64'rx='8'></rect></g></svg></div><div id='errors'style='margin-top:.5em;color:red'></div></div><script>const PANEL_GRIDSIZE=72,PANEL_WIDTH=16,PANEL_HEIGHT=12,XY="uXY";var sysObj=document.getElementById("sysButton"),params=getHashParams({sys:!1});async function loadPlugins(){var e;return document.querySelector("dialog#addElement")||(e=fetch("./board-new.htm").then((e=>e.text())).then((e=>{document.body.appendChild(document.createRange().createContextualFragment(e))}))),e}async function fetchJSON(e,n){return fetch(e,n).then((e=>e.json()))}window.addEventListener("hashchange",(function(){window.location.reload()})),sysObj.addEventListener("click",(function(e){params.sys=!toBool(params.sys),window.location.hash="sys="+params.sys}));const uElements={defs:{},impl:[],env:{},config:{},state:{}};var panelObj=document.getElementById("panel"),linksObj=document.getElementById("links"),viewObj=document.getElementById("viewport");const connectObj=document.getElementById("panel");panelObj.style.width="1152px",panelObj.style.height="864px";var DragObj=null,DragMode=null,DragOffset=null,nodes={},edges=[];function createEdges(e,n){n.split(",").forEach((function(n){var t=n.split("?")[0];edges.push({src:e,srcPin:"out",tar:t,tarPin:"in"})}))}function createNodes(e){jsonParse(e,(function(n,t,o){n.length>1&&"/"===n[0]&&(n=n.substring(1));var s=n.split("/");if(s.length>=2){var r=JSON.stringify(e[s[0]][s[1]],null,2),a=s[0].toLowerCase(),d=a+"/"+s[1].toLowerCase();if(toBool(params.sys)||!uElements.defs[a]||0==toBool(uElements.defs[a].sys)){var i=nodes[d];i||((i=nodes[d]={id:d}).icon=a,i.conf=r),t&&"on"==t.substring(0,2)&&createEdges(d,o)}}}))}function placeNodes(){var e=0,n=1;edges=edges.filter((function(e){const n=nodes[e.src]&&nodes[e.tar];return n||(createHTMLElement(document.querySelector("#errors"),"p").textContent=`undeliverable action: ${e.src}->${e.tar}`),n})),Object.values(nodes).forEach((e=>{e._out=e._in=0})),edges.forEach((e=>{nodes[e.src]._out++,nodes[e.tar]._in++}));let t=JSON.parse(window.localStorage.getItem(XY)||"{}");Object.entries(nodes).forEach((([o,s])=>{t[o]?(s._x=t[o]._x,s._y=t[o]._y,s._fixed=!0):0==s._out&&0==s._in?(s._x=e++,s._y=0):(s._x=6+s._in-s._out,s._x=Math.max(s._x,0),s._y=n++)}))}function posInUse(e,n){return Object.values(nodes).find((t=>{if(t._x==e&&t._y==n)return t}))}function lineInUse(e){var n=null;return Object.values(nodes).forEach((function(t){n||t._y!=e||(n=t)})),n}function yForce(e){var n=0,t=0,o=nodes[e]._y;return edges.forEach((function(s){s.src==e&&(n+=nodes[s.tar]._y-o,t++),s.tar==e&&(n+=nodes[s.src]._y-o,t++)})),n/t}function moveNodes(){var e=!1;for(var n in nodes){var t=nodes[n];t._fixed||(f=yForce(n),f<-.5&&!posInUse(t._x,t._y-1)&&(t._y--,e=!0))}for(var o=0;o<12;o++)if(!lineInUse(o))for(var n in nodes){var s=nodes[n];s._y===o+1&&(s._y--,e=!0)}return e}function handleNode(e){var n=!1,t=nodes[e],o=t._x,s=t._y,r=0,a=0;return t._fixed||(edges.forEach((n=>{if(n.src==e){var t=nodes[n.tar];t._x-o<2&&(r-=1),t._x-o>2&&(r+=1),t._y<s&&(a-=1),t._y>s&&(a+=1)}if(n.tar==e){var d=nodes[n.src];o-d._x<2&&(r+=1),o-d._x>2&&(r-=1),s<d._y&&(a+=1),s>d._y&&(a-=1)}})),r>0&&o++,r<0&&o--,a>0&&s++,a<0&&s--,posInUse(o,s)||(t._x=o,t._y=s,drawNodes(),drawEdges(),n=!0)),n}function drawNodes(){for(var e in nodes){var n=e.split("/")[0],t=nodes[e],o=uElements.defs[n],s=t.obj;if(!s){var r=document.getElementById("nodes");if(s=t.obj=document.querySelector("#templates .node").cloneNode(!0),r.appendChild(s),s.id=e,o){var a;if(o.events&&0==o.events.length)(a=s.querySelector('[pin="in"]'))&&(a.style.display="none");if(o.actions&&0==o.actions.length)(a=s.querySelector('[pin="out"]'))&&(a.style.display="none")}s.querySelector(".config").addEventListener("click",(function(e){for(var n=e.target;n&&!n.classList.contains("node");)n=n.parentElement;const t=n.getAttribute("data"),o=n.getAttribute("id").split("/");DialogFormClass.openModalForm("configElement",{...JSON.parse(t),type:o[0],id:o[1]})}))}t.icon&&s.querySelector(".icon").setAttribute("href","/icons.svg#"+t.icon),t.conf&&(s.querySelector("title").textContent=t.conf),s.setAttribute("data",t.conf),s.querySelector(".id").firstChild.textContent=e,moveSVGGroup(s,72*t._x+4,72*t._y+4)}const d={};Object.values(nodes).forEach((e=>{d[e.id]={_x:e._x,_y:e._y}})),window.localStorage.setItem(XY,JSON.stringify(d))}function drawSingleEdge(e,n,t){return e||(e=linksObj.ownerDocument.createElementNS("http://www.w3.org/2000/svg","path"),linksObj.appendChild(e)),e.setAttribute("d",`M ${n.x},${n.y} C ${n.x+48},${n.y} ${t.x-48},${t.y} ${t.x-12},${t.y} L ${t.x},${t.y}`),e}function drawEdges(){for(var e,n,t=0;t<edges.length;t++){var o=edges[t],s=nodes[o.src],r=nodes[o.tar];if(s&&r){var a=o.obj;e=_pinPos(s,o.srcPin),n=_pinPos(r,o.tarPin),a||(a=o.obj=linksObj.ownerDocument.createElementNS("http://www.w3.org/2000/svg","path"),linksObj.appendChild(a)),a.setAttribute("d",`M ${e.x},${e.y} C ${e.x+48},${e.y} ${n.x-48},${n.y} ${n.x-12},${n.y} L ${n.x},${n.y}`)}}}var _conPos,_conObj,p2=fetchJSON("/elements.json").then((e=>uElements.defs=e)),p3=fetchJSON("/env.json").then((e=>uElements.env=e)),p4=fetchJSON("/config.json").then((e=>uElements.config=e));Promise.all([p2,p3,p4]).then((function(){for(hub.write("env",JSON.stringify(uElements.env)),hub.write("config",JSON.stringify(uElements.config)),createNodes(uElements.env),createNodes(uElements.config),placeNodes();moveNodes(););var e,n=2*Object.keys(nodes).length;do{for(var t in e=!1,nodes)e=e||handleNode(t);n--}while(e&&n>0);drawNodes(),drawEdges(),loadPlugins()})),panelObj.addEventListener("mousedown",(function(e){if(!DragObj){for(var n=e.target;n&&n.attributes&&!n.attributes.dragabble;)n=n.parentNode;n&&n.attributes&&n.attributes.dragabble&&(DragObj=n)}if(DragObj)if("out"===DragObj.getAttribute("pin"))DragMode="c",DragOffset=getSVGPos(panelObj,e),DragObj=createSVGNode(panelObj,"circle",{cx:DragOffset.x,cy:DragOffset.y,r:10,style:"fill:lime"}),_conPos={x:DragOffset.x,y:DragOffset.y},_conObj=drawSingleEdge(void 0,_conPos,_conPos),console.log(_conPos);else{DragMode="n",DragOffset=getSVGPos(panelObj,e);var t=DragObj.getCTM();DragOffset.x-=t.e,DragOffset.y-=t.f}})),panelObj.addEventListener("mousemove",(function(e){if(DragObj){var n=getSVGPos(panelObj,e);moveSVGGroup(DragObj,n.x-DragOffset.x,n.y-DragOffset.y),"n"===DragMode?drawEdges():drawSingleEdge(_conObj,_conPos,n)}})),panelObj.addEventListener("mouseup",(function(e){if(DragObj){var n=getSVGPos(panelObj,e);for(var t in nodes)if(nodes[t].obj==DragObj){nodes[t]._x=Math.floor(n.x/72),nodes[t]._y=Math.floor(n.y/72);break}drawNodes(),drawEdges(),DragObj=null}})),window!==window.top&&(document.querySelector(".u-header").style.display="none",document.querySelector(".u-navbar").style.display="none")</script></body></html>