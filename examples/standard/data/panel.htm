<!doctype html><html><head><meta charset='utf-8'><meta name='viewport'content='width=device-width,initial-scale=1'><title>Element Panel</title><link href='/iotstyle.css'rel='stylesheet'type='text/css'><script src='micro.js'></script><script src='microsvg.js'></script><script src='panel.js'></script><style>#panel{fill:none;background-color:silver;background-image:linear-gradient(to top,rgba(0,0,0,.2) 1px,transparent 1px),linear-gradient(to left,rgba(0,0,0,.2) 1px,transparent 1px);background-size:12px 12px}#panel #templates{display:none}#links>line,#links>path{stroke:#080808;stroke-width:3;stroke-linecap:round;marker-end:url(#arrow)}.node{font-size:12px;font-family:sans-serif;fill:#000000;fill-opacity:1;stroke:none;font-style:normal;font-weight:400}.node rect{fill:#d4dced;stroke-width:0}.node circle{fill:#505050;stroke-width:0}.node text{font-size:10px}#Grid{fill:#e0e0e0;stroke:none}</style></head><body><div class='container'><div class='row u-header'><h1>Panel</h1></div><div class='row u-navbar'><a class='button'href='/'>Home</a> <a class='button'href='/board.htm'>Board</a> <a class='button'href='/microide.htm'>IDE</a> <a class='button'href='/log.htm'>Log</a> <span class='gap'></span> <button id='addButton'>+</button> <button id='unlock'>unlock</button> <button id='auto'>auto</button> <button id='sysButton'>sys</button></div><div class='row'style='margin-top:.5em;user-select:none'><svg id='panel'><defs><marker id='arrow'markerWidth='6'markerHeight='6'refX='16'refY='8'orient='auto'viewBox='0 0 16 16'><path d='M0,0 L0,16 L16,8 z'fill='currentColor'/></marker></defs><rect height='100%'width='100%'></rect><g id='templates'><g draggable='true'class='node'><title></title><rect width='64'height='64'rx='8'></rect><use class='icon'x='16'y='8'width='32'height='32'color='#203050'href=''/><use class='config'x='48'y='4'width='12'height='12'color='#203050'href='/icons.svg#config'/><text class='id'x='32'y='56'text-anchor='middle'>subtitle</text><circle pin='in'cx='8'cy='40'r='5'></circle><circle pin='out'draggable='true'cx='56'cy='40'r='5'></circle></g></g><g id='viewport'><g id='nodes'></g><g id='links'></g></g></svg></div></div><script>const PANEL_GRIDSIZE=72,NODE_SIZE=64,PANEL_WIDTH=16,PANEL_HEIGHT=12,XPref=64,ITERATE=200;class LAYOUT{XY="uXY";nodes={};edges=[];addNode(e,t,n){var o=this.nodes[e]??(this.nodes[e]={});o.id=e,o.icon=t,o.conf=n,o._x=0,o._y=0,o._fx=0,o._fy=0}addEdge(e,t){this.edges.push({src:e,srcPin:"out",tar:t,tarPin:"in"})}analyseChains(){for(const e of Object.values(this.nodes))e._out=e._in=0;this.edges=this.edges.filter((e=>{const t=this.nodes[e.src]&&this.nodes[e.tar];return t||console.log("undeliverable action:",e.src,e.tar),t})),this.edges.forEach((e=>{this.nodes[e.src]._out++,this.nodes[e.tar]._in++}))}placeSingleNodes(){let e=1;for(const t of Object.values(this.nodes))0==t._out&&0==t._in&&(t._x=e++,t._y=0,t._fixed=!0)}loadPlacements(){const e=JSON.parse(window.localStorage.getItem(this.XY)||"{}");for(const[t,n]of Object.entries(this.nodes))!n._fixed&&e[t]&&(n._x=e[t]._x,n._y=e[t]._y,n._fixed=!0)}}const layout=new LAYOUT;function constrain(e,t,n){return e<t?e=t:e>n&&(e=n),e}document.getElementById("unlock").addEventListener("click",(e=>{calcReset(!0)})),document.getElementById("auto").addEventListener("click",(e=>{for(let e=0;e<200;e++)moveNodes();drawNodes(),drawEdges()})),document.getElementById("addButton").addEventListener("click",(async e=>{await loadPlugins(),DialogClass.openModalForm("addElement",{})}));var params=getHashParams({sys:!1});async function loadPlugins(){var e;return document.querySelector("dialog#addElement")||(e=fetch("./board-new.htm").then((e=>e.text())).then((e=>{document.body.appendChild(document.createRange().createContextualFragment(e))}))),e}async function fetchJSON(e,t){return fetch(e,t).then((e=>e.json()))}window.addEventListener("hashchange",(function(){window.location.reload()})),document.getElementById("sysButton").addEventListener("click",(function(e){params.sys=!toBool(params.sys),window.location.hash="sys="+params.sys}));const uElements={defs:{},impl:[],env:{},config:{},state:{}};var panelObj=document.getElementById("panel"),linksObj=document.getElementById("links"),viewObj=document.getElementById("viewport");const connectObj=document.getElementById("panel");var DragNode;panelObj.style.width=PANEL_GRIDSIZE*PANEL_WIDTH+"px",panelObj.style.height=PANEL_GRIDSIZE*PANEL_HEIGHT+"px";var DragObj=null,DragMode=null,DragOffset=null,nodes={},edges=[];function createNodes(e){for(let[t,n]of Object.entries(e)){t=t.toLowerCase();for(let[e,o]of Object.entries(n))if(e=e.toLowerCase(),toBool(params.sys)||!uElements.defs[t]||!toBool(uElements.defs[t].sys)){const n=`${t}/${e}`;layout.addNode(n,t,o);for(let[e,t]of Object.entries(o))"on"==e.substring(0,2)&&t.split(",").forEach((function(e){layout.addEdge(n,e.split("?")[0])}))}}}function placeNodes(){var e=1;layout.analyseChains(),layout.placeSingleNodes(),layout.loadPlacements();for(const t of Object.values(this.nodes))t._fixed||(0===t._in?t._x=3:0===t._out?t._x=8:t._x=6+t._in-t._out,t._x=Math.max(t._x,0),t._y=e++)}function calcReset(e=!1){for(const t of Object.values(this.nodes))t._fx=0,t._fy=0,e&&(t._out>0||t._in>0)&&(t._fixed=!1)}function calcRepel(e,t){const n=t._x-e._x,o=t._y-e._y,s=n*n+o*o,a=.1*n/s,r=.1*o/s;e._fx-=a,e._fy-=r,t._fx+=a,t._fy+=r}function calcSpring(e,t){if(e&&t){const n=t._x-e._x,o=t._y-e._y,s=n*n+o*o,a=Math.sqrt(s),r=2*Math.log(a/2);let d=r*n/a,i=r*o/a;d-=.3,i*=2,e._fx+=d,e._fy+=i,t._fx-=d,t._fy-=i}}function moveForce(e){e._fixed||(e._x=constrain(e._x+.1*e._fx,0,PANEL_WIDTH-1),e._y=constrain(e._y+.1*e._fy,1,PANEL_HEIGHT-1))}function moveNodes(){calcReset();const e=[];for(const t of Object.values(nodes))if(t._y>0){for(const n of e)calcRepel(t,n);e.push(t)}for(const e of edges)calcSpring(nodes[e.src],nodes[e.tar]);for(const e of Object.values(nodes))moveForce(e)}function drawNodes(){for(var e in nodes){var t=e.split("/")[0],n=nodes[e],o=uElements.defs[t];const r=JSON.stringify(n.conf??{},null,2);var s=n.obj;if(!s){var a=document.getElementById("nodes");if(s=n.obj=document.querySelector("#templates .node").cloneNode(!0),a.appendChild(s),s.id=e,o){if(!o.events||0==o.events.length){const e=s.querySelector('[pin="in"]');e&&(e.style.display="none")}if(!o.actions||0==o.actions.length){const e=s.querySelector('[pin="out"]');e&&(e.style.display="none")}}s.querySelector(".config").addEventListener("click",(function(e){for(var t=e.target;t&&!t.classList.contains("node");)t=t.parentElement;const n=t.getAttribute("data"),o=t.getAttribute("id").split("/");DialogClass.openModalForm("configElement",{...JSON.parse(n),type:o[0],id:o[1]})}))}n.icon&&s.querySelector(".icon").setAttribute("href","/icons.svg#"+n.icon),s.querySelector("title").textContent=r,s.setAttribute("data",r),s.querySelector(".id").firstChild.textContent=e,moveSVGGroup(s,n._x*PANEL_GRIDSIZE+4,n._y*PANEL_GRIDSIZE+4)}const r={};Object.values(nodes).forEach((e=>{e._fixed&&(r[e.id]={_x:e._x,_y:e._y})})),window.localStorage.setItem(layout.XY,JSON.stringify(r))}function drawSingleEdge(e,t,n){return e||(e=linksObj.ownerDocument.createElementNS("http://www.w3.org/2000/svg","path"),linksObj.appendChild(e)),e.setAttribute("d",`M ${t.x},${t.y} C ${t.x+XPref},${t.y} ${n.x-XPref},${n.y} ${n.x-12},${n.y} L ${n.x},${n.y}`),e}function drawEdges(){for(var e,t,n=0;n<edges.length;n++){var o=edges[n],s=nodes[o.src],a=nodes[o.tar];if(s&&a){var r=o.obj;e=_pinPos(s,o.srcPin),t=_pinPos(a,o.tarPin),r||(r=o.obj=linksObj.ownerDocument.createElementNS("http://www.w3.org/2000/svg","path"),linksObj.appendChild(r)),r.setAttribute("d",`M ${e.x},${e.y} C ${e.x+XPref},${e.y} ${t.x-XPref},${t.y} ${t.x-12},${t.y} L ${t.x},${t.y}`)}}}var _conPos,_conObj,p2=fetchJSON("/elements.json").then((e=>uElements.defs=e)),p3=fetchJSON("/env.json").then((e=>uElements.env=e)),p4=fetchJSON("/config.json").then((e=>uElements.config=e)),p5=fetchJSON("/api/elements").then((e=>uElements.impl=e));Promise.all([p2,p3,p4,p5]).then((function(){hub.write("env",JSON.stringify(uElements.env)),hub.write("config",JSON.stringify(uElements.config)),createNodes(uElements.env),createNodes(uElements.config),nodes=layout.nodes,edges=layout.edges,placeNodes();for(let e=0;e<200;e++)moveNodes();drawNodes(),drawEdges(),loadPlugins()})),panelObj.addEventListener("mousedown",(function(e){if(!DragObj){for(var t=e.target;t&&t.attributes&&!t.attributes.draggable;)t=t.parentNode;t&&t.attributes&&t.attributes.draggable&&(DragObj=t)}let n=DragObj;for(;n&&!n.classList.contains("node");)n=n.parentElement;if(DragNode=Object.values(nodes).find((e=>e.obj===n)),DragObj)if("out"===DragObj.getAttribute("pin"))DragMode="c",DragOffset=getSVGPos(panelObj,e),DragObj=createSVGNode(panelObj,"circle",{cx:DragOffset.x,cy:DragOffset.y,r:10,style:"fill:lime"}),_conPos={x:DragOffset.x,y:DragOffset.y},_conObj=drawSingleEdge(void 0,_conPos,_conPos);else{DragMode="n",DragOffset=getSVGPos(panelObj,e);var o=DragObj.getCTM();DragOffset.x-=o.e,DragOffset.y-=o.f}})),panelObj.addEventListener("mousemove",(function(e){if(DragObj){var t=getSVGPos(panelObj,e);moveSVGGroup(DragObj,t.x-DragOffset.x,t.y-DragOffset.y),"n"===DragMode?drawEdges():drawSingleEdge(_conObj,_conPos,t)}})),panelObj.addEventListener("mouseup",(function(e){if(DragObj){var t=getSVGPos(panelObj,e);if("c"===DragMode){DragObj.remove(),_conObj.remove();const e=t.x/PANEL_GRIDSIZE,n=t.y/PANEL_GRIDSIZE,o=Object.values(nodes).find((t=>t._x<=e&&t._x+1>e&&t._y<=n&&t._y+1>n));o!==DragNode&&DialogClass.openModalForm("action",{srcId:DragNode.id,tarId:o.id},(e=>{e.srcEvent&&e.target&&e.action&&e.value&&(DragNode.conf[e.srcEvent]=`${e.target}?${e.action}=${e.value}`,changeConfig(DragNode.id,DragNode.conf))}))}else if("n"===DragMode){const e=Object.values(nodes).find((e=>e.obj===DragObj));e._x=Math.floor(6*(t.x-DragOffset.x)/PANEL_GRIDSIZE)/6,e._y=Math.floor(6*(t.y-DragOffset.y)/PANEL_GRIDSIZE)/6,e._fixed=!0}drawNodes(),drawEdges(),DragObj=null}})),window!==window.top&&(document.querySelector(".u-header").style.display="none",document.querySelector(".u-navbar").style.display="none")</script></body></html>