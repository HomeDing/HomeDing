"use strict";var MicroState,ModalDialogClass_1,__decorate=this&&this.__decorate||function(t,e,s,i){var n,o=arguments.length,a=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var l=t.length-1;0<=l;l--)(n=t[l])&&(a=(o<3?n(a):3<o?n(e,s,a):n(e,s))||a);return 3<o&&a&&Object.defineProperty(e,s,a),a};!function(t){t[t.PREP=1]="PREP",t[t.INIT=2]="INIT",t[t.LOADED=3]="LOADED"}(MicroState=MicroState||{});class MicroRegistry{constructor(){this._tco=null,this._registry={},this._state=MicroState.PREP,this._unloadedList=[],this.List=[],window.addEventListener("load",this.init.bind(this)),window.addEventListener("unload",this.onunload.bind(this))}loadFile(t){const e=this;return fetch(t).then(function(t){return t.text()}).then(function(t){t=document.createRange().createContextualFragment(t);e._tco&&e._tco.appendChild(t)})}attach(t){var e;this._state===MicroState.LOADED?!(e=t.getAttribute("u-is"))||(e=this._registry[e])&&this.loadBehavior(t,e):this._unloadedList.push(t)}_setPlaceholders(e,s){function i(e){return Object.getOwnPropertyNames(s).forEach(t=>e=e.replace(new RegExp("\\$\\{"+t+"\\}","g"),s[t])),e}if(s)if(e.nodeType===Node.TEXT_NODE)e.textContent&&(e.textContent=i(e.textContent));else if(e.nodeType===Node.ELEMENT_NODE){var n=e.attributes;for(let t=0;t<n.length;t++){const o=n[t].value;0<=o.indexOf("${")&&(e[n[t].name]&&void 0!==e[n[t].name].baseVal?e[n[t].name].baseVal=i(o):e.setAttribute(n[t].name,i(o)))}e.childNodes.forEach(t=>{this._setPlaceholders(t,s)})}}isVisible(t){let e=!1;return 0<t.offsetWidth&&0<t.offsetHeight&&(t=t.getBoundingClientRect(),e=t.top<=window.innerHeight&&0<=t.bottom),e}loadDataImage(t){t.dataset.src&&this.isVisible(t)&&(t.src=t.dataset.src)}insertTemplate(t,e,s){let i=null;if(t&&e&&this._tco){const n=this._tco.querySelector('[u-control="'+e.toLowerCase()+'"]');n&&(i=n.cloneNode(!0)),i&&(i.params=s,this._setPlaceholders(i,s),t.appendChild(i),t.querySelectorAll("[u-is]").forEach(t=>micro.attach(t)),this._setPlaceholders(i,s),t.querySelectorAll("[data-src]:not([src])").forEach(t=>this.loadDataImage(t)))}return i}getMethods(e){const s=new Set;for(;Object.getOwnPropertyNames(e).filter(t=>"function"==typeof e[t]).forEach(t=>s.add(t)),e=Object.getPrototypeOf(e););return s}loadBehavior(t,e){const s=e,i=t;if(t)if(e){if(i._attachedBehavior!==e){for(const n of t.attributes)t[n.name]||(t[n.name]=n.value);for(const o of this.getMethods(s))"on_touchstart"===o?t.addEventListener(o.substr(3),s[o].bind(t),{passive:!0}):"on_"===o.substr(0,3)?t.addEventListener(o.substr(3),s[o].bind(t),!1):"on"===o.substr(0,2)?t.addEventListener(o.substr(2),s[o].bind(t),!1):(null==s[o]||s[o].constructor!==Function)&&t[o]||(t[o]=s[o]);i._attachedBehavior=e,t.parentElement!==this._tco&&(i.connectedCallback(),this.List.push(t))}}else;else;}define(t,e){this._registry[t]=e}onunload(t){this.List.forEach(e=>{e&&e.term&&e.term();for(let t=0;t<e.attributes.length;t++)e[e.attributes[t].name]=null});for(let t=0;t<this.List.length;t++)delete this.List[t];this.List=[]}init(){this._state=MicroState.INIT,this._tco=document.getElementById("u-templates"),this._tco||(this._tco=createHTMLElement(document.body,"div",{id:"u-templates"})),"complete"===document.readyState?this.init2():document.addEventListener("readystatechange",this.init2)}init2(){"complete"===document.readyState&&(this._state=MicroState.LOADED,this._unloadedList.forEach(t=>{var e=t.getAttribute("u-is");e&&((e=this._registry[e])&&this.loadBehavior(t,e),this.List.push(t))}),this._unloadedList=[])}}const micro=new MicroRegistry;let obs=new MutationObserver(function(t,e){for(const s of t)s.addedNodes.forEach(t=>{const e=t;e.getAttribute&&e.getAttribute("u-is")&&micro.attach(t)})});obs.observe(document,{childList:!0,subtree:!0}),document.addEventListener("DOMContentLoaded",function(){function t(){document.querySelectorAll("[data-src]:not([src])").forEach(t=>micro.loadDataImage(t))}window.addEventListener("scroll",t),window.setTimeout(t,40)});class MicroControlClass{connectedCallback(){}_clearWhitespace(){var t;let e=this.firstChild;for(;e;){var s=e.nextSibling;3===e.nodeType&&null!==(t=e.parentNode)&&void 0!==t&&t.removeChild(e),e=s}}}function MicroControl(e){return function(t){return micro.define(e,new t),t}}let GenericWidgetClass=class extends MicroControlClass{connectedCallback(){super.connectedCallback(),this.microid||(this.microid=""),this.data={id:this.microid},this.actions=[],this.subId=hub.subscribe(this.microid+"?*",this.newData.bind(this)),hub.replay(this.subId)}newData(t,e,s){var i;e&&s&&(this.data[e]=s,(i=this.querySelector("img,h3"))&&setAttr(i,"title",JSON.stringify(this.data,null,1).replace("{\n","").replace("\n}",""))),"active"===e&&this.classList.toggle("active",toBool(s)),["span","div"].forEach(function(t){this.querySelectorAll(t+`[u-active='${e}']`).forEach(function(t){var e=toBool(s);setAttr(t,"value",e?"1":"0"),setAttr(t,"title",e?"active":"not active"),t.classList.toggle("active",e)})},this),["h2","h3","h4","span","button"].forEach(function(t){this.querySelectorAll(t+"[u-text='"+e+"']").forEach(function(t){t.textContent!==s&&(t.textContent=s)})},this),["input","select"].forEach(function(t){this.querySelectorAll(t+"[u-value='"+e+"']").forEach(function(t){"radio"===t.type?t.checked=t.value===s:t.value!==s&&(t.value=s||"")})},this),["button","label"].forEach(function(t){this.querySelectorAll(t+"[u-action='${"+e+"}']").forEach(function(t){setAttr(t,"u-action",s||"")})},this),this.querySelectorAll(`span[u-color='${e}']`).forEach(function(t){let e=s?s.replace(/^x/,"#"):"#888";e=e.replace(/^#\S{2}(\S{6})$/,"#$1"),t.style.backgroundColor=e})}dispatchNext(){if(this.actions){const e=this.actions.shift();var t;e&&(t=(t=e.split("="))[0]+"="+encodeURIComponent(t[1]),fetch(t).then(()=>{if(0<this.actions.length)debounce(this.dispatchNext.bind(this))();else try{updateAsap()}catch(t){}}))}}dispatchAction(t,e){t&&e&&(t.includes("/")?(t.replace("${v}",encodeURI(e)),t.split(",").forEach(t=>this.actions.push("/$board/"+t))):this.actions.push(`/$board${this.microid}?${t}=${encodeURI(e)}`),debounce(this.dispatchNext.bind(this))())}showSys(){return toBool(getHashParams({sys:!1}).sys)}on_change(t){const e=t.target;this.dispatchAction(e.getAttribute("u-value"),e.value)}on_click(t){const e=[];let s=t.target;for(;s&&(e.push(s),s!==this);)s=s.parentElement;e.every(t=>{let e=!1;return t.getAttribute("u-action")?this.dispatchAction(t.getAttribute("u-action"),t.getAttribute("value")||"1"):t.classList.contains("setconfig")?ModalDialogClass.open("configelementdlg",this.data):t.classList.contains("setactive")?this.dispatchAction(toBool(this.data.active)?"stop":"start","1"):t.classList.contains("setfocus")?ModalDialogClass.openFocus(this):e=!0,e})}};GenericWidgetClass=__decorate([MicroControl("generic")],GenericWidgetClass);let BL0937WidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this.mode||(this.mode="current"),this.data={id:this.microid},this.subId=hub.subscribe(this.microid+"?mode",this.switchMode.bind(this)),hub.replay(this.subId)}setMode(e){if(e&&e!==this.mode){let t;t=this.querySelector(`[u-text="${this.mode}"]`),null!==t&&void 0!==t&&t.parentElement&&(t.parentElement.style.display="none"),t=this.querySelector(`span[u-text="${e}"]`),null!==t&&void 0!==t&&t.parentElement&&(t.parentElement.style.display=""),this.mode=e}}switchMode(t,e,s){this.setMode(s)}on_click(t){const e=t.target;"mode"===e.getAttribute("u-action")&&this.setMode(e.value),super.on_click(t)}};BL0937WidgetClass=__decorate([MicroControl("bl0937")],BL0937WidgetClass);let ButtonGroupWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._blockElem=this.querySelector(".block"),this._count=0}newData(t,e,s){super.newData(t,e,s),e&&s&&"title"!==e&&(this._count%2==0&&(this._blockElem=createHTMLElement(this,"div",{class:"block"})),this._blockElem&&(createHTMLElement(this._blockElem,"button",{"u-action":s}).textContent=e),this._count++)}};ButtonGroupWidgetClass=__decorate([MicroControl("buttongroup")],ButtonGroupWidgetClass);let ButtonWidgetClass=class extends GenericWidgetClass{newData(t,e,s){super.newData(t,e,s),"onclick"===e?this._onclick=s:"ondoubleclick"===e?this._ondoubleclick=s:"onpress"===e&&(this._onpress=s)}on_click(){if(800<this._duration)this._onpress&&this.dispatchAction(this._onpress,"1");else{const t=this;this._timer&&window.clearTimeout(this._timer),this._timer=window.setTimeout(function(){t.dispatchAction(t._onclick,"1")},250)}}on_dblclick(){this._timer&&window.clearTimeout(this._timer),this.dispatchAction(this._ondoubleclick,"1")}on_pointerdown(){this._start=(new Date).valueOf()}on_pointerup(){this._duration=(new Date).valueOf()-this._start}};ButtonWidgetClass=__decorate([MicroControl("button")],ButtonWidgetClass);let ColorWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._value="00000000",this._hasWhite=!1,this._colObj=this.querySelector(".color")||{style:{}},this._hObj=this.querySelector(".hue")||{},this._sObj=this.querySelector(".band.saturation")||{style:{}},this._lObj=this.querySelector(".band.lightness")||{style:{}},this._wObj=this.querySelector(".white")||{}}newData(t,e,s){var i=this._value;s&&("value"===e?(i=this.normColor(s))!==this._value&&(this._value=i,i=this.wrgb(i),i=this.toHSL(i),this._hObj.value=i.h,this._sObj.value=i.s,this._lObj.value=i.l,this._update()):"config"===e&&(this._hasWhite=!0,this._wObj&&(this._wObj.style.display=this._hasWhite?"":"none"))),super.newData(t,e,s)}on_input(){this._value=this.to16(parseInt(this._wObj.value,10))+this.HSLToColor(this._hObj.value,this._sObj.value,this._lObj.value),this._update(),this.dispatchAction("value","x"+this._value)}_update(){var t=this.wrgb(this._value),e=this.toHSL(t),e=this.HSLToColor(e.h,100,50);this._sObj.style.background=`linear-gradient(to right, #808080 0%, #${e} 100%)`,this._lObj.style.background=`linear-gradient(to right, #000 0%, #${e} 50%, #fff 100%)`,this._colObj.style.backgroundColor=`#${this._value.substr(2)}`,this._wObj.value=String(t.w)}normColor(t){return t&&0!==t.length?6===(t="x"===t.substr(0,1)||"#"===t.substr(0,1)?t.substr(1):t).length&&(t="00"+t):t="00000000",t}wrgb(t){return{w:parseInt(t.substr(0,2),16),r:parseInt(t.substr(2,2),16),g:parseInt(t.substr(4,2),16),b:parseInt(t.substr(6,2),16)}}toHSL(t){const e={h:0,s:0,l:0};var s=t.r/255,i=t.g/255,n=t.b/255,o=Math.max(s,i,n),t=o-Math.min(s,i,n),i=t?o===s?(i-n)/t:o===i?2+(n-s)/t:4+(s-i)/t:0;return e.h=Math.round(60*i<0?60*i+360:60*i),e.s=Math.round(100*(t?o<=.5?t/(2*o-t):t/(2-(2*o-t)):0)),e.l=Math.round(100*(2*o-t)/2),e}HSLToColor(e,t,s){s/=100;const i=t=>(t+e/30)%12,n=(t/=100)*Math.min(s,1-s);t=t=>s-n*Math.max(-1,Math.min(i(t)-3,Math.min(9-i(t),1))),t={r:Math.round(255*t(0)),g:Math.round(255*t(8)),b:Math.round(255*t(4)),w:0};return this.toRGBColor(t)}to16(t){let e=t.toString(16);return 1===e.length&&(e="0"+e),e}toRGBColor(t){return this.to16(t.r)+this.to16(t.g)+this.to16(t.b)}};ColorWidgetClass=__decorate([MicroControl("color")],ColorWidgetClass);let DSTimeWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._nowObj=this.querySelector(".setnow"),window.setInterval(function(){setTextContent(this._nowObj,this.isoDate())}.bind(this),200)}on_click(t){const e=t.target;e&&e.classList.contains("setnow")?this.dispatchAction("time",this.isoDate()):super.on_click(t)}isoDate(){function t(t){return(t<10?"0":"")+t}const e=new Date;return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())}};DSTimeWidgetClass=__decorate([MicroControl("dstime")],DSTimeWidgetClass);let DisplayDotWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._dispElem=document.querySelector("#panel .display"),this._dispElem&&(this._elem=createHTMLElement(this._dispElem,"span",{class:"dot"}),this.updateElem()),this.showSys()||(this.style.display="none"),this._x=0,this._y=0,this._value=!1}newData(t,e,s){super.newData(t,e,s),e&&s&&this._elem&&("value"===e?this._value=toBool(s):"page"===e?this._elem.setAttribute("displayPage",s):"x"===e?this._x=Number(s):"y"===e&&(this._y=Number(s)),this.updateElem())}updateElem(){this._elem&&(this._elem.style.top=this._y+"px",this._elem.style.left=this._x+"px",this._elem.classList.toggle("active",this._value))}};DisplayDotWidgetClass=__decorate([MicroControl("displaydot")],DisplayDotWidgetClass);let DisplayLineWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._dispElem=document.querySelector("#panel .display"),this._dispElem&&(this._elem=createHTMLElement(this._dispElem,"span",{class:"line"}),this.updateElem()),this.showSys()||(this.style.display="none"),this._x0=0,this._x1=0,this._y0=0,this._y1=0}newData(t,e,s){super.newData(t,e,s),e&&s&&this._elem&&("page"===e?this._elem.setAttribute("displayPage",s):null!=this["_"+e]&&(this["_"+e]=s),this.updateElem())}updateElem(){this._elem&&(this._elem.style.top=this._y0+"px",this._elem.style.left=this._x0+"px",this._elem.style.width=this._x1-this._x0+"px",this._elem.style.height=this._y1-this._y0+"px")}};DisplayLineWidgetClass=__decorate([MicroControl("displayline")],DisplayLineWidgetClass);let DisplayTextWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._dispElem=document.querySelector("#panel .display"),this._dispElem&&(this._grid=Number(this._dispElem.getAttribute("grid")||1),this._elem=createHTMLElement(this._dispElem,"span",{class:"text",style:"top:0;left:0;display:none"})),this.showSys()||(this.style.display="none"),this._prefix="",this._postfix=""}newData(t,e,s){var i;super.newData(t,e,s),e&&s&&this._elem&&("value"===e?(i=`${this._prefix}${s}${this._postfix}`.replace(/ /g,"&nbsp;"),this._elem.innerHTML!==i&&(this._elem.innerHTML=i)):"page"===e?this._elem.setAttribute("displayPage",s):"x"===e?(i=Number(s)*this._grid,this._elem.style.left=(1<this._grid?7*i/10:i)+"px"):"y"===e?this._elem.style.top=Number(s)*this._grid+"px":"fontsize"===e?(this._elem.style.fontSize=s+"px",this._elem.style.lineHeight=s+"px",this._elem.style.height=s+"px"):"prefix"===e?this._prefix=s:"postfix"===e&&(this._postfix=s))}};DisplayTextWidgetClass=__decorate([MicroControl("displaytext")],DisplayTextWidgetClass);let DisplayWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._page="",this._dialogElem=this.querySelector(".display")}newData(t,e,s){super.newData(t,e,s),e&&s&&"page"===e&&s!==this._page&&(this._page=s,null!==(s=this._dialogElem)&&void 0!==s&&s.querySelectorAll(":scope > span").forEach(t=>{var e=t.getAttribute("displayPage")||"1";t.style.display=e===this._page?"":"none"}))}};DisplayWidgetClass=__decorate([MicroControl("display")],DisplayWidgetClass);let IncludeWidgetClass=class extends MicroControlClass{connectedCallback(){const t=document.querySelector("#u-templates "+this.ref);if(t){var e=t.cloneNode(!0);const s=this.parentElement;null!==s&&void 0!==s&&s.replaceChild(e,this)}}};IncludeWidgetClass=__decorate([MicroControl("include")],IncludeWidgetClass);let InputWidgetClass=class extends MicroControlClass{connectedCallback(){var t=this.querySelector("input");"INPUT"!==(this._input=this).tagName&&t&&(this._input=t),super.connectedCallback();let e=this._input.getAttribute("type")||"text";"range"===e&&this._input.classList.contains("switch")&&(e="switch",this._input.min="0",this._input.max="1"),this._type=e,this._value=this._input.value,this._clearWhitespace()}_check(){let t=this._value;var e=this._type;"checkbox"===e?t=this._input.checked?"1":"0":"range"!==e&&"switch"!==e||(t=this._input.value),t!==this._value&&(this._value=t,this._input.dispatchEvent(new Event("change",{bubbles:!0})))}on_change(){this._check()}on_click(t){let e=t.target;for(this._value=this._input.value;e;){if("range"===this._type||"switch"===this._type){const i=e.classList;if(i.contains("up")){var s=Number(this._input.value)+Number(this._input.step||1);this._input.value=String(s);break}if(i.contains("down")){s=Number(this._input.value)-Number(this._input.step||1);this._input.value=String(s);break}}if("switch"===this._type&&(e===this._input||e===this)){this._input.value=String(1-Number(this._input.value));break}if(e===this)break;e=e.parentElement}this._input.focus(),this._check()}};function jsonParse(t,o){!function e(t,s,i){let n=s?t+"/"+s:t;if(n=n.replace("/[","["),Array.isArray(i))for(let t=0;t<i.length;t++)e(n,"["+t+"]",i[t]);else"object"==typeof i?(o(n,null,null),Object.getOwnPropertyNames(i).forEach(t=>e(n,t,i[t]))):o(t,s,String(i))}("","",t)}function jsonFind(t,e){const s=(e="/"===e[0]?e.substr(1):e).split("/");for(;t&&0<s.length;){var i=s[0];t[i]||(t[i]={}),t=t[i],s.shift()}return t}InputWidgetClass=__decorate([MicroControl("input")],InputWidgetClass);let LogWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),this._SVGObj=this.querySelector("object"),this._xFormat="datetime",this._yFormat="num"}loadData(){const t=this._fName;let s="";var e=fetch(t,{cache:"no-store"}).then(function(t){return t.text()}).then(function(t){s=s+"\n"+t}),i=fetch(t.replace(".txt","_old.txt"),{cache:"no-store"}).then(function(t){return t.text()}).then(function(t){s=t+"\n"+s}).catch(function(){});Promise.allSettled([e,i]).then(function(){const e=/^\d{4,},\d+/,t=s.split("\n").filter(function(t){return t.match(e)});this._api.draw(this._chart,t.map(function(t){t=t.split(",");return{x:t[0],y:t[1]}}))}.bind(this))}loadSVG(){let e=!1;if(this._SVGObj){let t=null;try{t=this._SVGObj.getSVGDocument()}catch(t){}t&&t.api&&(this._api=this._SVGObj.getSVGDocument().api,this._chart=this._api.add("line",{linetype:"line"}),this._api.add(["VAxis",{type:"hAxis",options:{format:"datetime"}},{type:"indicator",options:{xFormat:this._xFormat,yFormat:this._yFormat}}]),this.loadData(),e=!0)}e||window.setTimeout(this.loadSVG.bind(this),1e3)}newData(t,e,s){super.newData(t,e,s),"filename"===e?(this._fName=s,this.loadSVG()):"xformat"===e?this._xFormat=s:"yformat"===e&&(this._yFormat=s)}};LogWidgetClass=__decorate([MicroControl("log")],LogWidgetClass);let ModalDialogClass=ModalDialogClass_1=class extends MicroControlClass{static open(t,e){const s=micro.insertTemplate(document.body,"modal",e);s.open(t,e)}static openFocus(t){const e=micro.insertTemplate(document.body,"modal",{});e.openFocus(t)}static next(t,e){const s=this._stack[this._stack.length-1];s.next(t,e)}static save(t){var e;const s=null===(e=this._stack[this._stack.length-2]._frameObj)||void 0===e?void 0:e.firstElementChild;s.save&&s.save(t)}static close(){const t=this._stack[this._stack.length-1];t.close()}connectedCallback(){super.connectedCallback(),this._frameObj=this.querySelector(".modalFrame")}_handleEsc(t){"Escape"===t.key&&ModalDialogClass_1._stack[ModalDialogClass_1._stack.length-1]===this&&this.close()}open(t,e){ModalDialogClass_1._stack.push(this),this._keyHandler=this._handleEsc.bind(this),document.addEventListener("keydown",this._keyHandler);const s=micro.insertTemplate(this._frameObj,t,e),i=null===s||void 0===s?void 0:s.querySelector("input,button,select");null!==i&&void 0!==i&&i.focus()}next(t,e){var s;null!==(s=this._frameObj.firstElementChild)&&void 0!==s&&s.remove();const i=micro.insertTemplate(this._frameObj,t,e),n=null===i||void 0===i?void 0:i.querySelector("input,button,select");null!==n&&void 0!==n&&n.focus()}openFocus(t){if(ModalDialogClass_1._stack.push(this),t&&t.parentElement){this._keyHandler=this._handleEsc.bind(this),document.addEventListener("keydown",this._keyHandler);var e=(this._focusObj=t).getBoundingClientRect();this._placeObj=createHTMLElement(t.parentElement,"div",{style:"width:"+e.width+"px;height:"+e.height+"px",class:t.className},t);var s=Math.min(4,(window.innerWidth-64)/e.width);s=Math.min(s,(window.innerHeight-64)/e.height);const i=createHTMLElement(this._frameObj,"div",{style:"width:"+s*e.width+"px;height:"+s*e.height+"px"});e=i.getBoundingClientRect();t.classList.add("modal-object"),t.style.top=e.top+"px",t.style.left=e.left+"px",t.style.width=e.width+"px",t.style.height=e.height+"px"}}on_click(t){const e=t.target;"close"===e.getAttribute("u-action")&&this.close()}close(){var t;if(document.removeEventListener("keydown",this._keyHandler),this._focusObj){const e=this._focusObj;e.classList.remove("modal-object"),e.style.top="",e.style.left="",e.style.width="",e.style.height="",null!==(t=this._placeObj)&&void 0!==t&&t.remove()}ModalDialogClass_1._stack.pop(),this.remove()}};ModalDialogClass._stack=[],ModalDialogClass=ModalDialogClass_1=__decorate([MicroControl("modal")],ModalDialogClass);let PWMOutWidgetClass=class extends GenericWidgetClass{connectedCallback(){super.connectedCallback(),hub.subscribe(this.microid+"?*",this.newValue.bind(this)),this._range=255,this._last=""}newValue(t,e,s){if(s){if("range"===e)this._range=Number(s);else if("value"===e&&this._last!==s){const i=this.querySelector(".ux-levelbar");e=i.offsetHeight;let t=e*Number(s)/this._range;t>e-1&&(t=e-1),t<1&&(t=1),i.style.borderBottomWidth=t+"px",this._last=s}}else;}};function toBool(t){if(!t)return!1;switch(t.toLowerCase().trim()){case"true":case"yes":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(t)}}function toSeconds(t){let e=0;return t=t.toLowerCase(),e=t.endsWith("h")?60*parseInt(t,10)*60:t.endsWith("m")?60*parseInt(t,10):t.endsWith("s")?parseInt(t,10):t.includes(":")?(Date.parse("1.1.1970 "+t)-Date.parse("1.1.1970"))/1e3:Number(t),e}function setTextContent(t,e){t.textContent!==e&&(t.textContent=e)}function setAttr(t,e,s){t.getAttribute(e)!==s&&t.setAttribute(e,s)}function changeConfig(t,e){let s,i,n;n="/env.json",s=JSON.parse(hub.read("env")),i=jsonFind(s,t),0===Object.keys(i).length&&(n="/config.json",s=JSON.parse(hub.read("config")),i=jsonFind(s,t));for(const a in e)e[a]?i[a]=e[a]:delete i[a];const o=new FormData;o.append(n,new Blob([JSON.stringify(s)],{type:"text/html"}),n),fetch("/",{method:"POST",body:o}).then(function(){window.alert("saved.")})}function debounce(s,i=20){let n;return function(){const t=this,e=arguments;n&&clearTimeout(n),n=window.setTimeout(function(){n=0,s.apply(t,e)},i)}}function getHashParams(t){const e=Object.assign({},t);return window.location.hash.substr(1).split("&").forEach(function(t){t=t.split("=");e[t[0]]=t[1]}),e}function createHTMLElement(t,e,s,i=null){const n=document.createElement(e);if(s)for(const o in s)s.hasOwnProperty(o)&&n.setAttribute(o,s[o]);return i?t.insertBefore(n,i):t.appendChild(n),n}PWMOutWidgetClass=__decorate([MicroControl("pwmout")],PWMOutWidgetClass);let TimerWidgetClass=class extends GenericWidgetClass{constructor(){super(...arguments),this.wt=0,this.pt=0,this.ct=0,this.time=0}newData(t,e,s){if(super.newData(t,e,s),"waittime"===e?this.wt=toSeconds(s):"pulsetime"===e?this.pt=toSeconds(s):"cycletime"===e?this.ct=toSeconds(s):"time"===e&&(this.time=toSeconds(s)),this.ct<this.wt+this.pt&&(this.ct=this.wt+this.pt),0<this.ct){const i=this.querySelector(".u-bar");s=i.clientWidth/this.ct;const n=i.querySelector(".pulse");n.style.left=Math.floor(this.wt*s)+"px",n.style.width=Math.floor(this.pt*s)+"px";const o=i.querySelector(".current");o.style.width=Math.floor(this.time*s)+"px"}}};TimerWidgetClass=__decorate([MicroControl("timer")],TimerWidgetClass);class MicroHub{constructor(){this._registrations={},this._registrationsId=0,this._store={}}read(t){return this._findStoreObject(this.pPath(t))[this.pKey(t)]}write(t,e){const s=this._findStoreObject(this.pPath(t));s[this.pKey(t)]=e}subscribe(t,e,s=!1){var i=this._registrationsId;const n=t.toLocaleLowerCase();t="^"+n.replace(/(\[|\]|\/|\?)/g,"\\$1").replace(/\*\*/g,"\\S{0,}").replace(/\*/g,"[^/?]*")+"$";const o={id:i,match:RegExp(t),callback:e};return this._registrations[i]=o,this._registrationsId++,s&&jsonParse(this._store,function(t,e,s){let i=t+(e?"?"+e:"");i&&(i=i.toLocaleLowerCase(),i.match(o.match)&&o.callback(t,e?e.toLowerCase():null,s))}.bind(this)),i}unsubscribe(t){delete this._registrations[t]}replay(t){const n=this._registrations[t];n&&jsonParse(this._store,function(t,e,s){let i=t+(e?"?"+e:"");i&&(i=i.toLocaleLowerCase(),i.match(n.match)&&n.callback(t,e?e.toLowerCase():null,s))}.bind(this))}publishObj(t){jsonParse(t,function(t,e,s){this.publishValue(t,e?e.toLowerCase():"",s||"")}.bind(this))}publishValue(e,s,i){let n=e+(s?"?"+s:"");if(n){if(s){const t=this._findStoreObject(e);t[s]=i}n=n.toLocaleLowerCase(),Object.values(this._registrations).forEach(t=>{n.match(t.match)&&t.callback(e,s,i)})}}onunload(){Object.getOwnPropertyNames(this._registrations).forEach(t=>delete this._registrations[t])}_findStoreObject(t){let e=this._store;const s=(t="/"===t[0]?t.substr(1):t).split("/");for(;0<s.length&&e[s[0]];)e=e[s[0]],s.shift();for(;0<s.length&&s[0];)e=e[s[0]]={},s.shift();return e}pPath(t){const e=(t="/"===t[0]?t.substr(1):t).split("/");return e.slice(0,e.length-1).join("/")}pKey(t){t=t.split("/");return t[t.length-1]}}const hub=new MicroHub;window.addEventListener("unload",hub.onunload.bind(hub),!1);