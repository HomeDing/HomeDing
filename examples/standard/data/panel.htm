<!doctype html><html><head><meta charset='utf-8'><meta name='viewport'content='width=device-width,initial-scale=1'><title>Element Panel</title><link href='/iotstyle.css'rel='stylesheet'type='text/css'><script src='micro.js'></script><script src='panel.js'></script><style>#panel{fill:none;background-color:silver;background-image:linear-gradient(to top,rgba(0,0,0,.2) 1px,transparent 1px),linear-gradient(to left,rgba(0,0,0,.2) 1px,transparent 1px);background-size:72px 72px}#panel #templates{display:none}#links>line{stroke:#080808;stroke-width:2;stroke-linecap:round}.node{font-size:12px;font-family:sans-serif;fill:#000000;fill-opacity:1;stroke:none;font-style:normal;font-weight:400}.node rect{fill:#d4dced;stroke-width:0}.node circle{fill:#505050;stroke-width:0}.node text{font-size:10px}#Grid{fill:#e0e0e0;stroke:none}</style></head><body><div class='container'><div class='row u-header'><h1>Panel</h1></div><div class='row u-navbar'><a class='button'href='/'>Home</a> <a class='button'href='/board.htm'>Board</a> <a class='button'href='/microide.htm'>IDE</a> <a class='button'href='/log.htm'>Log</a> <span class='gap'></span> <button id='sysButton'>sys</button></div><div class='row'style='margin-top:.5em'><svg id='panel'><rect height='100%'width='100%'></rect><g id='templates'><g dragabble='true'class='node'><title></title><rect width='64'height='64'rx='8'></rect><use class='icon'x='16'y='8'width='32'height='32'color='#203050'href=''/><use class='config'x='48'y='4'width='12'height='12'color='#203050'href='/icons.svg#config'/><text class='id'x='32'y='56'text-anchor='middle'>subtitle</text><circle pin='in'cx='8'cy='40'r='5'></circle><circle pin='out'cx='56'cy='40'r='5'></circle></g></g><g id='viewport'><g id='nodes'></g><g id='links'></g></g></svg></div><div id='errors'style='margin-top:.5em;color:red'></div></div><script>var elementDef,envDef,configDef,sysObj=document.getElementById("sysButton"),PANEL_GRIDSIZE=72,PANEL_WIDTH=16,PANEL_HEIGHT=12,params=getHashParams({sys:!1});window.addEventListener("hashchange",(function(){window.location.reload()})),sysObj.addEventListener("click",(function(e){params.sys=!toBool(params.sys),window.location.hash="sys="+params.sys}));var panelObj=document.getElementById("panel"),viewObj=document.getElementById("viewport");panelObj.style.width=PANEL_GRIDSIZE*PANEL_WIDTH+"px",panelObj.style.height=PANEL_GRIDSIZE*PANEL_HEIGHT+"px";var DragObj=null,DragOffset=null,nodes={},edges=[];function createEdges(e,n){n.split(",").forEach((function(n){var o=n.split("?")[0];edges.push({src:e,srcPin:"out",tar:o,tarPin:"in"})}))}function createNodes(e){jsonParse(e,(function(n,o,t){n.length>1&&"/"===n[0]&&(n=n.substring(1));var s=n.split("/");if(s.length>=2){var r=JSON.stringify(e[s[0]][s[1]],null,2),a=s[0].toLowerCase(),d=a+"/"+s[1].toLowerCase();if(toBool(params.sys)||!elementDef[a]||0==toBool(elementDef[a].sys)){var i=nodes[d];i||((i=nodes[d]={id:d}).icon=a,i.conf=r),o&&"on"==o.substring(0,2)&&createEdges(d,t)}}}))}function placeNodes(){var e=0,o=1;for(n in edges=edges.filter((function(e){const n=nodes[e.src]&&nodes[e.tar];return n||(createHTMLElement(document.querySelector("#errors"),"p").textContent=`undeliverable action: ${e.src}->${e.tar}`),n})),p=0,nodes)nodes[n]._out=nodes[n]._in=0;for(n in edges.forEach((function(e){nodes[e.src]._out++,nodes[e.tar]._in++})),nodes)0==nodes[n]._out&&0==nodes[n]._in?(nodes[n].xPos=e++,nodes[n].yPos=0):(nodes[n].xPos=6+nodes[n]._in-nodes[n]._out,nodes[n].xPos=Math.max(nodes[n].xPos,0),nodes[n].yPos=o++)}function posInUse(e,n){var o=null;return Object.values(nodes).forEach((function(t){o||t.xPos!=e||t.yPos!=n||(o=t)})),o}function lineInUse(e){var n=null;return Object.values(nodes).forEach((function(o){n||o.yPos!=e||(n=o)})),n}function yForce(e){var n=0,o=0,t=nodes[e].yPos;return edges.forEach((function(s){s.src==e&&(n+=nodes[s.tar].yPos-t,o++),s.tar==e&&(n+=nodes[s.src].yPos-t,o++)})),n/o}function moveNodes(){var e=!1;for(var n in nodes){var o=nodes[n];f=yForce(n),f<-.5&&!posInUse(o.xPos,o.yPos-1)&&(o.yPos--,e=!0)}for(var t=0;t<12;t++)if(!lineInUse(t))for(var n in nodes){var s=nodes[n];s.yPos===t+1&&(s.yPos--,e=!0)}return e}function handleNode(e){var n=!1,o=nodes[e],t=o.xPos,s=o.yPos,r=0,a=0;return edges.forEach((function(n){if(n.src==e){var o=nodes[n.tar];o.xPos-t<2&&(r-=1),o.xPos-t>2&&(r+=1),o.yPos<s&&(a-=1),o.yPos>s&&(a+=1)}if(n.tar==e){var d=nodes[n.src];t-d.xPos<2&&(r+=1),t-d.xPos>2&&(r-=1),s<d.yPos&&(a+=1),s>d.yPos&&(a-=1)}})),r>0&&t++,r<0&&t--,a>0&&s++,a<0&&s--,posInUse(t,s)||(o.xPos=t,o.yPos=s,updateNodes(),updateEdges(),n=!0),n}function updateNodes(){for(var e in nodes){var n=e.split("/")[0],o=nodes[e],t=elementDef[n],s=o.obj;if(!s){var r=document.getElementById("nodes");if(s=o.obj=document.querySelector("#templates .node").cloneNode(!0),r.appendChild(s),s.id=e,t){var a;if(t.events&&0==t.events.length)(a=s.querySelector('[pin="in"]'))&&(a.style.display="none");if(t.actions&&0==t.actions.length)(a=s.querySelector('[pin="out"]'))&&(a.style.display="none")}s.querySelector(".config").addEventListener("click",(function(e){for(var n=e.target;n&&!n.classList.contains("node");)n=n.parentElement}))}o.icon&&s.querySelector(".icon").setAttribute("href","/icons.svg#"+o.icon),o.conf&&(s.querySelector("title").textContent=o.conf),s.setAttribute("data",o.conf),s.querySelector(".id").firstChild.textContent=e,moveSVGGroup(s,o.xPos*PANEL_GRIDSIZE+4,o.yPos*PANEL_GRIDSIZE+4)}}function updateEdges(){for(var e,n=document.getElementById("links"),o=0;o<edges.length;o++){var t=edges[o],s=nodes[t.src],r=nodes[t.tar];if(s&&r){var a=t.obj;a||(a=t.obj=n.ownerDocument.createElementNS("http://www.w3.org/2000/svg","line"),n.appendChild(a)),e=_pinPos(s,t.srcPin),a.setAttribute("x1",e.x),a.setAttribute("y1",e.y),e=_pinPos(r,t.tarPin),a.setAttribute("x2",e.x),a.setAttribute("y2",e.y)}}}var p1=fetch("/env.json").then((function(e){return e.json()})).then((function(e){return envDef=e,fetch("/config.json")})).then((function(e){return e.json()})).then((function(e){configDef=e})),p2=fetch("/elements.json").then((function(e){return e.json()})).then((function(e){elementDef=e}));Promise.all([p1,p2]).then((function(){for(createNodes(envDef),createNodes(configDef),placeNodes();moveNodes(););var e,n=2*Object.keys(nodes).length;do{for(var o in e=!1,nodes)e=e||handleNode(o);n--}while(e&&n>0);updateNodes(),updateEdges()})),panelObj.addEventListener("mousedown",(function(e){if(!DragObj){for(var n=e.target;n&&n.attributes&&!n.attributes.dragabble;)n=n.parentNode;n&&n.attributes&&n.attributes.dragabble&&(DragObj=n)}if(DragObj){DragOffset=getSVGPos(panelObj,e);var o=DragObj.getCTM();DragOffset.x-=o.e,DragOffset.y-=o.f}})),panelObj.addEventListener("mousemove",(function(e){if(DragObj){var n=getSVGPos(panelObj,e);moveSVGGroup(DragObj,n.x-DragOffset.x,n.y-DragOffset.y),updateEdges()}})),panelObj.addEventListener("mouseup",(function(e){if(DragObj){var n=getSVGPos(panelObj,e);for(var o in nodes)if(nodes[o].obj==DragObj){nodes[o].xPos=Math.floor(n.x/PANEL_GRIDSIZE),nodes[o].yPos=Math.floor(n.y/PANEL_GRIDSIZE);break}updateNodes(),updateEdges(),DragObj=null}})),window!==window.top&&(document.querySelector(".u-header").style.display="none",document.querySelector(".u-navbar").style.display="none")</script></body></html>